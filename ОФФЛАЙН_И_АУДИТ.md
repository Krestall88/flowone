# 📱 Оффлайн-режим и безопасность Audit Mode

## 🎯 Проблема: Металлические стены блокируют сигнал

### Реальность пищевых производств:
- **Сэндвич-панели с металлом** экранируют Wi-Fi сигнал
- **Холодильные камеры** - это клетки Фарадея
- **Производственные цеха** часто находятся в подвалах
- **Повар не будет ждать** восстановления связи - вернётся к бумаге

### Решение: Progressive Web App (PWA) с оффлайн-режимом

---

## 🔧 Архитектура оффлайн-режима

### Компоненты системы:

```
┌─────────────────────────────────────────────────────────┐
│                    Пользователь                          │
│              (повар с планшетом в цеху)                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              PWA (Progressive Web App)                   │
│  • Работает как нативное приложение                      │
│  • Устанавливается на домашний экран                     │
│  • Работает без интернета                                │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        ▼                         ▼
┌──────────────┐          ┌──────────────┐
│   Service    │          │  IndexedDB   │
│   Worker     │◄────────►│  (локальное  │
│  (кеширует)  │          │   хранилище) │
└──────┬───────┘          └──────────────┘
       │
       │ Автоматическая синхронизация
       │ при восстановлении связи
       ▼
┌─────────────────────────────────────────────────────────┐
│                    API Server                            │
│              (Next.js + Prisma)                          │
└────────────────────┬────────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│              PostgreSQL (Supabase)                       │
│         с Row Level Security (RLS)                       │
└─────────────────────────────────────────────────────────┘
```

---

## 📝 Как работает оффлайн-режим

### 1. Заполнение журнала БЕЗ интернета:

```typescript
// Повар открывает журнал температур
// Интернета нет ❌

1. UI загружается из кеша Service Worker
2. Справочники (оборудование, локации) загружены из IndexedDB
3. Повар вводит температуру: +4°C для "Холодильник №1"
4. Данные сохраняются в IndexedDB с флагом synced: false
5. Показывается индикатор: "📤 Ожидает отправки: 1"
```

### 2. Автоматическая синхронизация:

```typescript
// Интернет появился ✅

1. Service Worker ловит событие 'online'
2. Запускается OfflineSyncManager
3. Достаёт все записи с synced: false из IndexedDB
4. Отправляет на сервер через API
5. При успехе помечает synced: true
6. Показывает: "✅ Синхронизировано: 1"
7. Очищает синхронизированные записи
```

### 3. Обработка ошибок:

```typescript
// Если отправка не удалась:

1. Увеличивает retryCount
2. Повторяет попытку через 30 секунд
3. Максимум 3 попытки
4. После 3 неудач - удаляет запись и логирует ошибку
```

---

## 🚀 Установка PWA

### Для пользователя:

**На Android:**
1. Откройте сайт в Chrome
2. Нажмите меню (⋮) → "Добавить на главный экран"
3. Иконка появится рядом с другими приложениями
4. Работает как обычное приложение

**На iOS:**
1. Откройте сайт в Safari
2. Нажмите "Поделиться" (□↑)
3. "Добавить на экран Домой"
4. Иконка появится на домашнем экране

**На компьютере:**
1. Откройте сайт в Chrome/Edge
2. В адресной строке появится иконка установки
3. Нажмите "Установить"
4. Приложение откроется в отдельном окне

---

## 💾 Что кешируется для оффлайн работы

### Автоматически кешируется:

✅ **Страницы:**
- Dashboard
- Журналы (температур, здоровья)
- HACCP Plan
- Уведомления

✅ **Справочники:**
- Список оборудования
- Список сотрудников
- Локации

✅ **Статические ресурсы:**
- CSS стили
- JavaScript код
- Иконки и изображения

❌ **НЕ кешируется:**
- API запросы (они идут напрямую)
- Данные других пользователей
- Конфиденциальная информация

---

## 🔒 Безопасность Audit Mode (КРИТИЧНО!)

### Проблема: Обход интерфейса

Аудиторы часто проверяют:
```sql
-- Можно ли подправить данные напрямую в базе?
UPDATE "TemperatureEntry" 
SET temperature = 5 
WHERE id = 123;

-- Если это работает во время аудита = ПРОВАЛ проверки! ❌
```

### Решение: Трёхуровневая защита

#### Уровень 1: UI блокировка (базовая)
```typescript
// В компонентах React
if (auditMode.isActive) {
  return <div>Редактирование заблокировано</div>;
}
```
**Проблема:** Легко обойти через DevTools или прямой API запрос

#### Уровень 2: API Middleware (важная)
```typescript
// В API routes
export const POST = withAuditModeCheck(async (req) => {
  // Проверяет наличие активной сессии аудита
  // Возвращает HTTP 403 если аудит активен
  await blockIfAuditMode('CREATE_TEMPERATURE');
  // ... остальной код
});
```
**Проблема:** Можно обойти, подключившись к базе напрямую

#### Уровень 3: Row Level Security (КРИТИЧНАЯ!) ⭐
```sql
-- В PostgreSQL/Supabase
CREATE POLICY "block_modifications_during_audit"
ON "TemperatureEntry"
FOR ALL
USING (NOT is_audit_mode_active())
WITH CHECK (NOT is_audit_mode_active());
```
**Результат:** Даже прямое подключение к базе НЕ СМОЖЕТ изменить данные!

---

## 🛡️ Настройка Row Level Security в Supabase

### Шаг 1: Выполнить SQL скрипт

```bash
# Подключитесь к Supabase SQL Editor
# Выполните файл: prisma/rls-audit-mode.sql
```

### Шаг 2: Проверка работы RLS

```sql
-- 1. Активируем тестовую сессию аудита
INSERT INTO "AuditSession" (
  "auditType", 
  "auditorName", 
  status, 
  "startedAt"
) VALUES (
  'Роспотребнадзор', 
  'Иванов И.И.', 
  'active', 
  NOW()
);

-- 2. Пытаемся изменить температуру
UPDATE "TemperatureEntry" 
SET morning = 10 
WHERE id = 1;

-- Ожидаемый результат:
-- ERROR: Operation blocked: Audit mode is active. 
-- All data modifications are frozen during audit.

-- 3. Проверяем лог нарушений
SELECT * FROM "AuditModeViolation" 
ORDER BY "createdAt" DESC 
LIMIT 10;

-- Должна быть запись о попытке изменения!
```

### Шаг 3: Завершаем тестовую сессию

```sql
UPDATE "AuditSession" 
SET status = 'completed', 
    "endedAt" = NOW() 
WHERE status = 'active';

-- Теперь изменения снова разрешены
```

---

## 📊 Мониторинг попыток обхода

### Таблица AuditModeViolation

Логирует ВСЕ попытки изменить данные во время аудита:

```sql
SELECT 
  "attemptedOperation",  -- INSERT/UPDATE/DELETE
  "tableName",           -- Какую таблицу пытались изменить
  "userId",              -- Кто пытался (если известно)
  "ipAddress",           -- Откуда
  "createdAt"            -- Когда
FROM "AuditModeViolation"
WHERE "sessionId" = 123  -- ID конкретной сессии аудита
ORDER BY "createdAt" DESC;
```

### Отчёт для аудитора:

```typescript
// API endpoint: /api/audit/violations
{
  "sessionId": 123,
  "auditType": "Роспотребнадзор",
  "violations": [
    {
      "timestamp": "2026-01-27T10:30:00Z",
      "operation": "UPDATE",
      "table": "TemperatureEntry",
      "blocked": true,
      "message": "Попытка изменить температуру во время проверки"
    }
  ],
  "totalAttempts": 1,
  "allBlocked": true  // ✅ Все попытки заблокированы!
}
```

---

## 🧪 Тестирование оффлайн-режима

### Сценарий 1: Потеря связи в процессе работы

```bash
# 1. Откройте журнал температур
# 2. В Chrome DevTools: Network → Offline
# 3. Введите температуру
# 4. Проверьте: появился индикатор "Ожидает отправки"
# 5. Network → Online
# 6. Проверьте: данные автоматически отправились
```

### Сценарий 2: Работа полностью оффлайн

```bash
# 1. Загрузите приложение онлайн (кеш заполнится)
# 2. Отключите Wi-Fi на устройстве
# 3. Откройте приложение (должно загрузиться из кеша)
# 4. Заполните несколько записей
# 5. Включите Wi-Fi
# 6. Проверьте: все записи синхронизировались
```

### Сценарий 3: Проверка блокировки во время аудита

```bash
# 1. Активируйте Audit Mode через UI
# 2. Попробуйте создать запись температуры
# 3. Ожидаемо: HTTP 403 Forbidden
# 4. Попробуйте через SQL напрямую в Supabase
# 5. Ожидаемо: ERROR + запись в AuditModeViolation
```

---

## 📱 Рекомендации для производства

### Оборудование:

✅ **Планшеты с LTE/4G** - не зависят от Wi-Fi
✅ **Защищённые чехлы** - производство = грязь и влага
✅ **Большие экраны** (10"+) - удобнее вводить данные
✅ **Долгая батарея** - смена длится 8-12 часов

### Сеть:

✅ **Усилители Wi-Fi** в производственных зонах
✅ **Mesh-сети** для покрытия всей территории
✅ **Резервный 4G роутер** на случай проблем с основным интернетом

### Процесс:

✅ **Обучите персонал** работе в оффлайн
✅ **Покажите индикатор синхронизации** - пусть знают, что данные сохранены
✅ **Проверяйте синхронизацию** в конце смены
✅ **Не паникуйте** при потере связи - данные не потеряются

---

## 🔍 Для аудиторов

### Как проверить защиту от изменений:

1. **Попросите активировать Audit Mode**
2. **Попробуйте изменить данные через UI** → должна быть блокировка
3. **Попросите доступ к Supabase Dashboard**
4. **Попробуйте выполнить UPDATE через SQL Editor** → должна быть ошибка
5. **Проверьте таблицу AuditModeViolation** → все попытки залогированы

### Что должно быть:

✅ Блокировка на уровне UI (видимая пользователю)
✅ Блокировка на уровне API (HTTP 403)
✅ Блокировка на уровне БД (RLS policies)
✅ Логирование всех попыток обхода
✅ Невозможность удалить логи нарушений

### Красные флаги:

❌ Можно изменить данные через SQL
❌ Нет логов попыток изменения
❌ Блокировка только на фронтенде
❌ Можно деактивировать Audit Mode без прав

---

## 📈 Метрики и мониторинг

### Dashboard для администратора:

```typescript
{
  "offline": {
    "pendingEntries": 5,        // Записей ожидает синхронизации
    "lastSyncSuccess": "10:30",  // Последняя успешная синхронизация
    "failedSyncs": 0             // Неудачных попыток
  },
  "audit": {
    "isActive": true,
    "sessionId": 123,
    "violationAttempts": 2,      // Попыток обойти блокировку
    "allBlocked": true           // Все заблокированы
  }
}
```

---

## 🎓 Обучение персонала

### Что объяснить поварам:

1. **"Зелёная галочка"** = данные отправлены на сервер
2. **"Жёлтый треугольник"** = ожидает отправки, всё нормально
3. **"Красный крестик"** = нет связи, данные сохранены локально
4. **Не паниковать** при потере связи - просто продолжайте работать
5. **В конце смены** проверьте, что все данные синхронизированы

### Что объяснить руководству:

1. **Audit Mode блокирует ВСЁ** - даже прямой доступ к базе
2. **Все попытки обхода логируются** - можно показать аудитору
3. **Оффлайн-режим критичен** для производства с плохим сигналом
4. **PWA работает как приложение** - не нужно устанавливать из магазина

---

## 🚨 Troubleshooting

### Проблема: Данные не синхронизируются

**Проверьте:**
1. Есть ли интернет? (индикатор в правом нижнем углу)
2. Не активен ли Audit Mode? (красный баннер вверху)
3. Не превышен ли лимит попыток? (проверьте retryCount в IndexedDB)

**Решение:**
```typescript
// Принудительная синхронизация
await offlineSyncManager.forceSyncNow();
```

### Проблема: RLS не блокирует изменения

**Проверьте:**
1. Включен ли RLS на таблице?
   ```sql
   SELECT tablename, rowsecurity 
   FROM pg_tables 
   WHERE schemaname = 'public';
   ```
2. Созданы ли policies?
   ```sql
   SELECT * FROM pg_policies 
   WHERE tablename = 'TemperatureEntry';
   ```
3. Работает ли функция is_audit_mode_active()?
   ```sql
   SELECT is_audit_mode_active();
   ```

---

## ✅ Чеклист готовности

### Перед запуском в production:

- [ ] PWA манифест настроен
- [ ] Service Worker зарегистрирован
- [ ] IndexedDB инициализируется корректно
- [ ] Оффлайн индикатор отображается
- [ ] Синхронизация работает автоматически
- [ ] RLS policies созданы в Supabase
- [ ] Функция is_audit_mode_active() работает
- [ ] Таблица AuditModeViolation создана
- [ ] API middleware проверяет Audit Mode
- [ ] Протестирована работа оффлайн
- [ ] Протестирована блокировка во время аудита
- [ ] Персонал обучен работе с оффлайн-режимом
- [ ] Руководство понимает защиту Audit Mode

---

**Документ подготовлен:** Январь 2026  
**Версия:** 1.0  
**Критичность:** ВЫСОКАЯ - обе функции критичны для реального производства
