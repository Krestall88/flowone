# Обзор системы FlowOne

## 1. Назначение платформы

FlowOne — это единая платформа управления предприятием, объединяющая:

- **Электронный документооборот** с маршрутами согласования и исполнением.
- **Производственные журналы**, в том числе:
  - Журнал температуры холодильного оборудования.
  - Журнал здоровья сотрудников.

Цель системы — убрать бумажный документооборот и ручные журналы, сократить ошибки из‑за человеческого фактора и дать руководству прозрачную картину по ключевым процессам.

---

## 2. Технологический стек

- **Frontend / Backend**: Next.js 14 (App Router), React 18, TypeScript.
- **База данных**: PostgreSQL.
- **ORM**: Prisma.
- **Аутентификация**: NextAuth (credentials), хранение сессий.
- **PDF‑отчёты**: `@react-pdf/renderer`.

Все основные пользовательские экраны реализованы как серверные компоненты Next.js с клиентскими компонентами для интерактивных частей (формы, переходы по датам, редактирование и т.п.).

---

## 3. Структура данных (Prisma-модели)

### 3.1. Пользователи и роли

Модель `User`:

- `id`, `email`, `password`, `name`, `role`.
- Телеграм‑поля для интеграции: `telegramId`, `telegramChatId`, `telegramUsername`, `telegramBindingCode` и др.
- Связи с документами (`documents`, `recipientDocuments`, `responsibleDocuments`, `watchingDocuments`).
- Связи с задачами (`tasks`, `executionAssignments`).
- Связи с журналами: `temperatureEntries`, `healthChecks`.

Типичные роли:

- `director` — директор.
- `accountant` — главный бухгалтер.
- `head` — руководитель подразделения / производства.
- `employee` — рядовой сотрудник.
- `journals_admin` — админ журнала (ответственный за заполнение журналов).

### 3.2. Документы и файлы

- `Document` — основной объект документооборота:
  - Автор (`author`), получатель (`recipient`), ответственный (`responsible`).
  - Статус (`status`), текущий шаг (`currentStep`).
  - Текстовые поля (`title`, `body`, `content`, `executionNotes`).
  - Связанные файлы (`files`), задачи (`tasks`), наблюдатели (`watchers`), назначения на исполнение (`executionAssignments`).

- `File` — прикреплённые файлы к документу:
  - `url`, `name`, `size`, `createdAt`.

- `Task` — шаги согласования документа:
  - Ссылка на документ и исполнителя.
  - `step`, `status`, `action`, `instruction`.
  - Признаки `canSkip`, `commentRequired`, `returnedToAuthor`.

- `DocumentWatcher` — пользователи, которые являются наблюдателями документа.

- `ExecutionAssignment` — задачи по реальному исполнению документа:
  - Ссылка на документ и исполнителя.
  - `status` (enum `ExecutionStatus`), `deadline`, `comment`.

### 3.3. Журнал температуры

- `Location` — локация (цех, склад и т.п.).
- `Equipment` — единица оборудования в локации:
  - `name`, `locationId`, `type` (например: `fridge`, `freezer`, `showcase`).
  - Нормативы температуры: `targetTemp`, `tolerance`.
- `TemperatureEntry` — запись температур:
  - Ссылка на `equipment` и `user`.
  - `date` — дата измерений (уникальна в связке с `equipmentId`).
  - `morning`, `day`, `evening` — показания по сменам.
  - `signedAt` — момент подписи журнала за день.

### 3.4. Журнал здоровья сотрудников

- `Employee` — сотрудник для журнала здоровья:
  - `name`, `position?` (должность), `active` (активен/заблокирован).
- `HealthCheck` — журнал здоровья за конкретный день и пользователя:
  - `date`, `userId`, `signedAt`.
  - `entries` — связь с `HealthCheckEmployee`.
- `HealthCheckEmployee` — запись по конкретному сотруднику в журнале:
  - Ссылка на `HealthCheck` и `Employee`.
  - `status` (здоров, отстранён, отпуск, выходной, больничный) и опциональный `note`.

---

## 4. Модуль журналов

### 4.1. Общая навигация

- **`/journals`** — главная страница журналов:
  - Карточки активных журналов (температура, здоровье).
  - Каждая карточка **полностью кликабельна** и имеет яркий hover‑эффект.
  - При переходе дата из панели дат (если выбрана) прокидывается как `?date=YYYY-MM-DD`.

- **`JournalsSidebar`** — боковая панель в разделе журналов:
  - Ссылки на отдельные журналы и историю.
  - Пункт "Архив" удалён; остаются только актуальные разделы.

- **`JournalsDateToolbar`** — общая панель выбора даты:
  - Кнопки: предыдущий день, следующий день, "Сегодня".
  - Поле выбора даты (`type="date"`).
  - Яркий визуальный стиль.
  - Если за день есть данные, показывается зелёный бейдж **«Есть заполненные журналы»** и усиливается обводка блока.

### 4.2. Журнал температуры (`/journals/temperature`)

#### Назначение

Учёт температурного режима холодильного оборудования по трём точкам в течение дня (утро, день, вечер) для всех локаций предприятия.

#### Ключевые возможности

- Навигация по датам через `JournalsDateToolbar`.
- Выбор нужной даты, просмотр и редактирование записей.
- Ведение температур по всем единицам оборудования в структуре локаций.
- Отображение **локаций даже без оборудования**, чтобы было видно всю структуру.
- Понятные визуальные индикаторы разворачивания локаций (зелёная стрелка, которая вращается при открытии/закрытии).
- PDF‑экспорт журнала за выбранный день.

#### Логика работы

1. При загрузке страницы:
   - Определяется дата по `searchParams.date` или берётся текущий день.
   - По пользователю (через сессию) определяется `userId` для будущих записей.
   - Загружаются все `Location` и связанное `Equipment`.
   - Загружаются `TemperatureEntry` за выбранный день и строится карта значений (утро/день/вечер).
   - Рассчитывается, есть ли данные за день (`hasData`) и был ли журнал подписан (`signedAt`).

2. В интерфейсе:
   - Локации отображаются аккордеонами, по умолчанию **свернуты**.
   - В шапке каждой локации — зелёная стрелка, явно показывающая, что блок раскрывается.
   - Внутри локации — список оборудования с полями ввода температур.

3. При вводе температур:
   - Значения сохраняются в локальном состоянии React (по оборудованию и времени суток).

4. При подписи журнала:
   - Вызывается `POST /api/journals/temperature` с данными по всем заполненным полям.
   - На бэкенде:
     - Все записи `TemperatureEntry` за этот день и пользователя обновляются/создаются через upsert‑логику.
     - Проставляется `signedAt` у записей.
   - Дата, в которую были внесены данные, помечается как "имеющая данные" для визуального индикатора в `JournalsDateToolbar`.

5. Экспорт в PDF:
   - Кнопка "Экспорт в PDF" ведёт на `/api/journals/temperature/pdf?date=YYYY-MM-DD`.
   - В API‑роуте:
     - Загружаются все данные журнала за день.
     - Формируется PDF через React‑компонент в отдельном `render.tsx`.
     - Пользователь получает файл с отчётом по выбранной дате.

### 4.3. Журнал здоровья сотрудников (`/journals/health`)

#### Назначение

Фиксация состояния здоровья линейного персонала перед началом смены, с возможностью быстро отметить допуск/отстранение и оставить комментарий.

#### Ключевые возможности

- Навигация по датам через `JournalsDateToolbar`.
- Список **активных** сотрудников (заблокированные не отображаются).
- Быстрый выбор статуса по кнопкам с цветовой кодировкой.
- Поле "Примечание" для каждого сотрудника.
- Строка поиска по ФИО и должности.
- Управление справочником сотрудников (добавление, редактирование, блокировка, удаление).
- Подпись журнала за день (фиксируется время подписи и пользователь).
- Отображение статуса подписи в шапке журнала и на панели дат.
- PDF‑экспорт журнала здоровья.

#### Логика работы по датам и сохранению

1. При открытии `/journals/health`:
   - Определяется текущий пользователь через сессию.
   - Дата берётся из `searchParams.date` или из текущей даты.
   - Строится `selectedDate` (Date) через `parseISO`.
   - По email пользователя находится `dbUser` в БД, далее используется `dbUser.id`.

2. Загрузка данных журнала за день:
   - Выполняется `prisma.healthCheck.findFirst` с условием:
     - `userId = dbUser.id`.
     - `date = selectedDate` (строгое сравнение по дате, без диапазона по времени).
   - Если запись найдена, её `entries` мапятся в `initialStatuses` и `initialNotes` по `employeeId`.
   - Вычисляются:
     - `hasData = !!existingCheck`.
     - `signedLabel` — дата/время подписи, форматированная для вывода.

3. Работа клиентского компонента `HealthJournal`:
   - Принимает `employees`, `date` (строка `YYYY-MM-DD`), `initialStatuses`, `initialNotes`, `signedLabel`.
   - Локальное состояние:
     - `statuses` и `notes` — словари по `employeeId`.
     - Эффект `useEffect` следит за изменением `date`/`initialStatuses`/`initialNotes` и сбрасывает локальное состояние при смене даты.
   - Пользователь назначает статусы кнопками (здоров, отстранён, отпуск и т.д.).
   - Вводит примечания при необходимости.

4. Подпись журнала здоровья:
   - При нажатии "Подписать весь журнал":
     - Формируется `FormData` с полями `date`, `status-{employeeId}`, `note-{employeeId}`.
     - Отправляется `POST /api/journals/health`.

5. Бэкенд‑логика в `/api/journals/health`:
   - Пользователь определяется через `requireUser()` и далее `dbUser` по email.
   - Дата парсится из формы и приводится к `Date` через `parseISO`.
   - Для данной даты и пользователя:
     - Ищутся все существующие `HealthCheck` с точным `date`.
     - Все найденные `HealthCheckEmployee` и `HealthCheck` **удаляются**.
   - Создаётся **одна** новая запись `HealthCheck` с `date = day` и всеми переданными `entries`.
   - Благодаря этому гарантируется **один журнал на пользователя и день**.

6. Обновление UI после сохранения:
   - Если `POST` успешен, клиентский компонент:
     - Показывает сообщение об успехе.
     - Вызывает `router.refresh()`, чтобы перезагрузить серверный компонент страницы и сразу подтянуть свежие данные.
   - После этого, даже если пользователь сразу перелистывает дату вперёд/назад и возвращается, статусы видны уже с **первого сохранения**.

#### Управление сотрудниками

- **Добавление сотрудника**:
  - Открывается диалог, вводятся ФИО и опционально должность.
  - Запрос `POST /api/journals/employees` создаёт запись `Employee`.
  - После успеха страница перезагружается и новый сотрудник появляется в списке.

- **Редактирование сотрудника**:
  - Кнопка "Редактировать" рядом с каждым сотрудником.
  - В диалоге можно изменить ФИО, должность и флаг активности ("Активен" / "Заблокирован").
  - Запрос `PATCH /api/journals/employees` обновляет запись.

- **Удаление сотрудника**:
  - В диалоге редактирования есть кнопка удаления.
  - Запрос `DELETE /api/journals/employees?id=...` удаляет сотрудника и связанные с ним записи журнала.

---

## 5. Модуль документооборота

### 5.1. Главный дашборд (`/` и `/dashboard`)

- Яркий лендинг‑дашборд с двумя основными блоками:
  - "Электронный документооборот" → ссылка `/login` (вход в модуль документов).
  - "Производственные журналы" → ссылка `/journals/login` (вход в модуль журналов).
- Краткое маркетинговое описание возможностей платформы.

### 5.2. Просмотр документа (`/documents/[id]`)

Страница документа показывает:

- Заголовок, статус, инициатора, ответственного, текущего исполнителя в маршруте.
- Таймлайн всех задач согласования (`Task`):
  - Для каждого шага: исполнитель, роль, тип действия (утверждение, согласование, ознакомление и т.п.).
  - Визуальные индикаторы: выполнено, в ожидании, отклонено.
- Содержимое документа (`document.body`) в виде форматированного текста.
- Прикреплённые файлы с предпросмотром.
- Список наблюдателей.
- Панель исполнения (`ExecutionPanel`) для задач исполнения.

Права доступа:

- Документ доступен, если пользователь:
  - Автор, получатель или ответственный.
  - Наблюдатель.
  - Исполнитель хотя бы одной задачи.
- В противном случае — `404` (нет доступа).

### 5.3. Логика маршрутов и задач

- Модель `Task` описывает маршрут согласования:
  - `step` — порядок шага.
  - `status` — `pending`, `approved`, `rejected`, `completed`.
  - `action` — тип шага (утверждение, согласование, ознакомление и т.п.).
  - `instruction` — текстовая инструкция для исполнителя.

- Для пользователя, у которого сейчас "ход":
  - Отображаются кнопки действий через компонент `TaskActions`.
  - В зависимости от `action` и настроек шага (можно ли пропустить, нужен ли комментарий) выводятся разные варианты.

- Прогресс по документу считается как доля выполненных задач ко всем задачам.

---

## 6. Скрипты и утилиты

### 6.1. Seed БД (`prisma/seed.ts`)

- Полностью очищает:
  - Журналы (сотрудники, локации, оборудование, записи).
  - Документы, файлы, задачи, пользователей.
- Создаёт набор тестовых пользователей (директор, бухгалтер, руководитель, снабженцы, админ журналов).
- Заполняет:
  - Локации и оборудование для журнала температуры.
  - Примерные записи `TemperatureEntry` за текущий день.
  - Справочник сотрудников для журнала здоровья.
  - Один пример журнала здоровья с разными статусами и примечаниями.

### 6.2. Очистка данных

- `npm run db:cleanup-docs` — скрипт очистки данных по документам (см. `scripts/cleanup-documents.ts`).
- `npm run db:reset-journals` — скрипт очистки данных журналов:
  - Удаляет все `HealthCheckEmployee`, `HealthCheck`, `TemperatureEntry`.

---

## 7. Краткое резюме возможностей

Система FlowOne на текущий момент умеет:

1. **Электронный документооборот**:
   - Хранить документы с маршрутами согласования.
   - Управлять шагами, статусами, комментариями и файлами.
   - Ограничивать доступ к документам по ролям и участию в маршруте.

2. **Производственные журналы**:
   - Вести журнал температур по локациям и оборудованию.
   - Вести журнал здоровья сотрудников с фиксированными статусами и примечаниями.
   - Показывать удобную навигацию по датам, с визуальной подсветкой дней, где есть данные.
   - Управлять справочниками сотрудников, локаций и оборудования.
   - Подписывать журналы (фиксация факта заполнения за смену).
   - Формировать PDF‑отчёты по каждому типу журнала.

3. **Администрирование и тестовые данные**:
   - Быстро разворачивать/очищать окружение через seed‑ и вспомогательные скрипты.

Этот документ можно использовать как внутреннюю спецификацию/описание системы, а при необходимости — расширять деталями по ролям, правам доступа и бизнес‑процессам предприятия.
