# Полный анализ проекта FlowOne

## 1. Архитектура и стек
- **Framework**: Next.js 14 (App Router), React 18, TypeScript.
- **UI**: Tailwind CSS + кастомные компоненты (серверные + клиентские).
- **Бэкенд**: Next.js route handlers (`app/api/**`).
- **БД**: PostgreSQL.
- **ORM**: Prisma.
- **Аутентификация**: NextAuth (credentials) + сессии.
- **PDF**: `@react-pdf/renderer` (рендер через React-компоненты).
- **Даты**: собственные утилиты `lib/date-utils.ts` для нормализации дат к UTC полночи (исправлено пересечение dev/prod).

## 2. Основные модули
### 2.1 Журналы
- **Температурный журнал** (`/journals/temperature`)
  - Учёт температур оборудования по сменам (утро/день/вечер).
  - Структура по локациям и оборудованию, локации видны даже без оборудования.
  - Интерактивные аккордеоны, цветовые индикаторы.
  - Подпись дня фиксирует `signedAt` и пользователя.
  - PDF за месяц: титульный лист + таблица на 31 день, Робото с кириллицей.
  - Дата хранения: UTC 00:00:00 (уникальный ключ `equipmentId + date`).

- **Журнал здоровья** (`/journals/health`)
  - Список активных сотрудников, быстрые статусы (здоров, отстранён, отпуск, выходной, больничный), примечания.
  - Управление справочником сотрудников (добавление/редактирование/блокировка/удаление).
  - Подпись дня, отображение статуса подписи.
  - PDF за месяц: титульный лист, таблица на 31 день, легенда статусов, Робото.
  - Дата хранения: UTC 00:00:00; один журнал на пользователя и день, записи переписываются атомарно.

- **Навигация по датам**: `JournalsDateToolbar` (кнопки +/- день, Сегодня, input type=date, индикатор наличия данных).
- **Боковая панель**: `JournalsSidebar` (ссылки на журналы, история).

### 2.2 Документооборот
- **Документы** (`/documents/[id]`): статус, маршрут, задачи, наблюдатели, файлы, панель исполнения.
- **Маршруты/задачи**: `Task` с шагом, статусом, типом действия, инструкцией; отображение прогресса и действий исполнителя.
- **Доступ**: автор/получатель/ответственный/наблюдатель/исполнитель задачи; иначе 404.
- **Главный дашборд**: лендинг с входом в документооборот и журналы.

## 3. Данные (Prisma модели — ключевое)
- **User**: email, password, name, role (`director`, `accountant`, `head`, `employee`, `journals_admin`), поля Telegram, связи с документами/журналами.
- **Document / File / Task / DocumentWatcher / ExecutionAssignment**: маршрут согласования и исполнения.
- **Location / Equipment**: структура локаций и оборудования с типом и нормами температуры.
- **TemperatureEntry**: `equipmentId`, `date` (UTC midnight), `morning/day/evening`, `userId`, `signedAt`.
- **Employee**: ФИО, должность?, active.
- **HealthCheck**: `date` (UTC midnight), `userId`, `signedAt`, `entries`.
- **HealthCheckEmployee**: `employeeId`, `status`, `note`.

## 4. Ключевые потоки и особенности
- **Сохранение температур**: форма -> POST `/api/journals/temperature` -> upsert по `equipmentId + date` -> проставляется `userId` и `signedAt` при подписи.
- **Сохранение здоровья**: форма -> POST `/api/journals/health` -> удаление существующих записей за день пользователя -> создание одной записи `HealthCheck` с пакетными `entries`.
- **PDF экспорт**: `/api/journals/{temperature|health}/pdf?date=YYYY-MM-DD` — собирает месяц, рендерит React-PDF с Робото (кириллица), титульный лист + таблица на 31 день, без лишних пустых строк по вертикали.
- **UTC-нормализация**: все даты журналов приводятся к UTC полночь при чтении/записи (решена невидимость данных между dev/prod).

## 5. Скрипты и утилиты
- `npm run db:reset-journals` — очистка журналов (HealthCheckEmployee, HealthCheck, TemperatureEntry).
- `scripts/migrate-dates-to-utc.ts` — миграция существующих дат журналов к UTC полночи (решение кросс-окружного рассинхрона).
- `scripts/check-db.ts` / `scripts/check-journals.sql` — быстрые выборки по журналам и пользователям.
- `prisma/seed.ts` — полный сид данных (пользователи, локации/оборудование, журнал температуры, сотрудники, пример журнала здоровья).
- Очистка документов: `npm run db:cleanup-docs`.

## 6. Аутентификация и сессии
- NextAuth credentials; пароли через bcrypt.
- Сессия содержит `id`, `role`, `email`, `name`; `requireUser()` защищает маршруты.

## 7. Важные решения и ограничения
- **Одна запись журнала здоровья на пользователя и день**: старая запись удаляется перед созданием новой.
- **Температура — уникальность по `equipmentId + date`**: апсерты при сохранении.
- **UTC даты** обязательны для всех путей журналов (UI, API, PDF, миграции).
- **Кириллица в PDF**: Roboto из CDN зарегистрирован в `render.tsx`.

## 8. Быстрый чек-лист по окружению
- `.env`: `DATABASE_URL`, `NEXTAUTH_SECRET` обязательно; при работе с Telegram — соответствующие токены.
- После изменений Prisma: `npx prisma generate` (учитывать возможные lock-ошибки на Windows, закрыть dev-сервер).
- Dev/Prod должны указывать на одну БД + одинаковую версию кода (UTC-функции обязательны).

## 9. Что уже улучшено недавно
- Исправлен рассинхрон журналов между dev/prod (UTC нормализация + миграция дат).
- PDF журналов переписаны в месячный формат, добавлен шрифт Roboto с кириллицей.
- Исправлен баг первого сохранения журнала здоровья (router.refresh и жёсткое сравнение по дате).

Этот документ дополняет `docs/system-overview.md` и даёт сжатую карту по стеку, данным и функционалу, включая недавние критические фиксы.
